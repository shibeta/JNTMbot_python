name: Nightly Build

on:
  # 每天凌晨4点 (UTC时间晚上8点) 自动运行
  schedule:
    - cron: '0 20 * * *'
  # 允许手动触发
  workflow_dispatch:

jobs:
  # --- 检查是否有新的提交 ---
  check_for_changes:
    name: Check for new commits
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # 获取所有历史记录，以便找到 tag
          fetch-depth: 0

      - name: Check for changes since last nightly tag
        id: check
        shell: bash
        run: |
          # 从远程获取所有 tag
          git fetch --all --tags

          # 获取当前分支的 HEAD commit SHA
          HEAD_SHA=$(git rev-parse HEAD)
          echo "Current HEAD SHA: $HEAD_SHA"

          # 获取 'nightly' tag 指向的 commit SHA。
          # 如果 tag 不存在 (例如首次运行), 命令会失败，我们将 NIGHTLY_SHA 设为空字符串。
          NIGHTLY_SHA=$(git rev-parse nightly 2>/dev/null || echo "")
          echo "Nightly tag SHA: $NIGHTLY_SHA"

          # 比较两个 SHA。如果不同，或者 nightly 标签不存在，则需要构建。
          if [ "$HEAD_SHA" != "$NIGHTLY_SHA" ]; then
            echo "发现新提交，开始构建。"
            echo "should_build=true" >> "$GITHUB_OUTPUT"
          else
            echo "自上次 nightly 发布以来无新提交，跳过构建。"
            echo "should_build=false" >> "$GITHUB_OUTPUT"
          fi

  # --- 构建 Python 部分 ---
  build_python:
    name: Build Python Executable
    runs-on: windows-latest
    needs: check_for_changes
    if: needs.check_for_changes.outputs.should_build == 'true'
    permissions:
      contents: read
    env:
      PYTHONUTF8: "1"  # 强制 Python 使用 UTF-8 模式
      PRODUCT_NAME: "德瑞Bot"
      PRODUCT_DESCRIPTION: "德瑞Bot自动开车脚本"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 静默安装 ViGEmBus 驱动，避免卡在 pip install vgamepad
      - name: Install ViGEmBus Driver from local MSI
        shell: pwsh
        run: |
          $msiPath = Join-Path $env:GITHUB_WORKSPACE "assets\虚拟手柄驱动ViGEmBusSetup_x64.msi"
          msiexec /i "$msiPath" /qn /norestart
          Write-Host "Waiting for ViGEmBus driver to settle..."
          Start-Sleep -Seconds 5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Generate PyInstaller Version Info
        shell: pwsh
        run: |
          pyivf-make_version `
          --product-name ${{ env.PRODUCT_NAME }} `
          --internal-name ${{ env.PRODUCT_NAME }} `
          --file-description ${{ env.PRODUCT_DESCRIPTION }} `
          --original-filename ${{ env.PRODUCT_NAME }}.exe `
          --version 0.1 `
          --outfile version_file.txt

      - name: Generate PyInstaller Spec
        shell: pwsh
        run: |
          pyi-makespec `
          --onedir --optimize 2 --console `
          --contents-directory resources `
          --icon ./assets/johnny_guns.ico `
          --version-file ./version_file.txt `
          --name ${{ env.PRODUCT_NAME }} `
          main.py

      - name: Package with PyInstaller
        shell: pwsh
        run: pyinstaller "${{ env.PRODUCT_NAME }}.spec" --noconfirm 

      - name: Debug - Print PyInstaller Warnings
        shell: pwsh
        run: |
          $warnFile = "./build/${{ env.PRODUCT_NAME }}/warn-${{ env.PRODUCT_NAME }}.txt"
          if (Test-Path $warnFile) {
            Write-Host "=== PyInstaller Warning File Content ==="
            Get-Content $warnFile
            Write-Host "======================================"
          }

      - name: Bundle runtime dependencies and documentation
        shell: pwsh
        run: |
          $releaseDir = "./dist/${{ env.PRODUCT_NAME }}"
          Write-Host "Organizing files into $releaseDir"

          # 复制 vgamepad DLL
          Write-Host "Copying vgamepad DLL..."
          $vgamepadPkgPath = python -c "import vgamepad, os; print(os.path.dirname(vgamepad.__file__))"
          $vigemDLLPath = Join-Path $vgamepadPkgPath "win\vigem\client"
          Write-Host "VGAMEPAD_VIGEM_DLL_PATH: $vigemDLLPath"
          Copy-Item -Path "$vigemDLLPath" -Destination "$releaseDir/resources/vgamepad/win/vigem/client" -Recurse -Force

          # 复制 ViGEmBus 驱动安装程序
          Write-Host "Copying ViGEmBus Driver Installer..."
          Copy-Item -Path "./assets/虚拟手柄驱动ViGEmBusSetup_x64.msi" -Destination "$releaseDir/虚拟手柄驱动ViGEmBusSetup_x64.msi" -Force

          # 复制配置文件
          Write-Host "Copying config file..."
          Copy-Item -Path "./config.yaml.example" -Destination "$releaseDir/config.yaml" -Force

          # 复制 RapidOCR 的可执行文件和模型文件
          Write-Host "Copying RapidOCR executable file..."
          Copy-Item -Path "./RapidOCR-json.exe" -Destination "$releaseDir/RapidOCR-json.exe" -Force
          Write-Host "Copying RapidOCR model..."
          Copy-Item -Path "./models" -Destination "$releaseDir/models" -Recurse -Force

          # 复制 README 文件
          Write-Host "Copying readme file..."
          Copy-Item -Path "./README.md" -Destination "$releaseDir/帮助文档.md" -Force
          Copy-Item -Path "./README.md" -Destination "$releaseDir/帮助文档.txt" -Force

      - name: Upload Python artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-artifact
          path: ./dist/${{ env.PRODUCT_NAME }}/

  # --- 构建 Node.js 部分 ---
  build_node:
    name: Build Node.js Executable
    runs-on: windows-latest
    needs: check_for_changes
    if: needs.check_for_changes.outputs.should_build == 'true'
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Node.js dependencies and build
        shell: bash
        run: |
          cd steam_bot
          npm install
          npm run build

      - name: Upload Node.js artifact
        uses: actions/upload-artifact@v4
        with:
          name: node-artifact
          path: ./steam_bot/dist/steam_bot.exe

  # --- 合并产物并创建 Release ---
  create_release:
    name: Create Nightly Release
    runs-on: windows-latest
    # 只有构建成功才需要发布
    needs: [build_python, build_node]
    # 为发布 Job 授予写权限
    permissions:
      contents: write

    steps:
      # 为 Release 命名需要当前日期
      - name: Set current date variable
        shell: pwsh
        run: echo "TODAY=$(Get-Date -Format 'yyyy-MM-dd')" >> $env:GITHUB_ENV

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          # 将下载的 artifacts 存放到 build_output 文件夹
          path: build_output

      - name: Prepare and package release files
        shell: pwsh
        id: package
        run: |
          # 定义目录和文件名
          $publishDir = "publish"
          $releaseSubDir = "$publishDir/release"
          $zipName = "JNTMbot_python_nightly.zip"
          $zipPath = "$publishDir/$zipName"

          New-Item -ItemType Directory -Force -Path $publishDir
          New-Item -ItemType Directory -Force -Path $releaseSubDir

          # 从下载的 artifacts 中复制构建好的文件
          Copy-Item -Path "./build_output/python-artifact/*" -Destination $releaseSubDir -Recurse -Force
          Copy-Item -Path "./build_output/node-artifact/steam_bot.exe" -Destination $releaseSubDir -Force

          # 打包为 zip
          Compress-Archive -Path "$releaseSubDir/*" -DestinationPath $zipPath -Force

          echo "zip_path=$zipPath" >> $env:GITHUB_OUTPUT

      - name: Create or update Nightly Release
        uses: andelf/nightly-release@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: 'nightly'
          name: 'Nightly Build ${{ env.TODAY }}'
          draft: false
          body: |
            这是 JNTMbot_python 的 nightly 版本，包含最新的更改和功能。
            它不稳定，可能包含未完成的功能和新引入的错误，**请小心使用**!
            推荐使用经过充分测试和验证后发布的 [稳定版](https://github.com/shibeta/JNTMbot_python/releases/latest) 。
          prerelease: true
          files: ${{ steps.package.outputs.zip_path }}
